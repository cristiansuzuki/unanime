{% load dict_extras %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Calendário de Demandas</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0d1b2a;
    color: #e0e1dd;
}

header {
    background: #1b263b;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

header a {
    color: #e0e1dd;
    text-decoration: none;
    font-size: 22px;
}

.container {
    padding: 20px;
}

.calendario {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
}

.dia-semana {
    text-align: center;
    font-weight: bold;
}

.dia {
    background: #ffffff;
    color: #000;
    min-height: 120px;
    border-radius: 10px;
    padding: 6px;
    cursor: pointer;
}

.dia:hover {
    background: #edf2fb;
}

.numero-dia {
    font-weight: bold;
}

/* DEMANDAS */
.demanda {
    margin-top: 4px;
    padding: 5px;
    border-radius: 6px;
    color: #fff;
    font-size: 12px;
    cursor: pointer;
}

/* STATUS */
.status-AB { background: #6c757d; }
.status-CO { background: #2a9d8f; }
.status-PE { background: #e63946; }

/* MODAIS */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    z-index: 10;
}

.modal-content {
    background: #fff;
    color: #000;
    width: 420px;
    margin: 8% auto;
    padding: 20px;
    border-radius: 10px;
}

.close {
    float: right;
    cursor: pointer;
    font-size: 20px;
}

label {
    display: block;
    margin-top: 10px;
}

input, textarea, select, button {
    width: 100%;
    margin-top: 5px;
}
</style>
</head>

<body>

<header>
    <a href="?ano={{ ano_anterior }}&mes={{ mes_anterior }}">◀</a>
    <strong>{{ mes }}/{{ ano }}</strong>
    <a href="?ano={{ proximo_ano }}&mes={{ proximo_mes }}">▶</a>
</header>

<div class="container">
<div class="calendario">

{% for d in dias_semana %}
<div class="dia-semana">{{ d }}</div>
{% endfor %}

{% for _ in espacos_vazios %}<div></div>{% endfor %}

{% for dia in total_dias %}
<div class="dia"
     data-data="{{ ano }}-{{ mes|stringformat:'02d' }}-{{ dia|stringformat:'02d' }}"
     onclick="abrirCriar(this.dataset.data)">

    <div class="numero-dia">{{ dia }}</div>

    {% for demanda in demandas_por_dia|get_item:dia %}
    <div class="demanda status-{{ demanda.status }}"
         draggable="true"
         data-id="{{ demanda.id }}"
         onclick="event.stopPropagation(); abrirEditar(
            '{{ demanda.id }}',
            '{{ demanda.titulo|escapejs }}',
            '{{ demanda.descricao|escapejs }}',
            '{{ demanda.status }}',
            '{{ demanda.responsavel.id }}',
            '{{ demanda.departamento.id }}'
         )">
        {{ demanda.titulo }}
    </div>
    {% endfor %}
</div>
{% endfor %}

</div>
</div>

<!-- ================= MODAL CRIAR ================= -->
<div id="modal-criar" class="modal">
<div class="modal-content">
<span class="close" onclick="fecharModal('modal-criar')">&times;</span>
<h3>Nova Demanda</h3>

<form method="POST" action="{% url 'criar_demanda' %}">
{% csrf_token %}
<input type="hidden" id="data-demanda" name="data">

<label>Título</label>
<input type="text" name="titulo" required>

<label>Descrição</label>
<textarea name="descricao"></textarea>

<label>Status</label>
<select name="status">
{% for v, l in status_choices %}
<option value="{{ v }}">{{ l }}</option>
{% endfor %}
</select>

<label>Responsável</label>
<select name="responsavel">
{% for u in usuarios %}
<option value="{{ u.id }}">{{ u.username }}</option>
{% endfor %}
</select>

<label>Departamento</label>
<select name="departamento">
{% for d in departamentos %}
<option value="{{ d.id }}">{{ d.nome }}</option>
{% endfor %}
</select>

<button type="submit">Salvar</button>
</form>
</div>
</div>

<!-- ================= MODAL EDITAR ================= -->
<div id="modal-editar" class="modal">
<div class="modal-content">
<span class="close" onclick="fecharModal('modal-editar')">&times;</span>
<h3>Editar Demanda</h3>

<form method="POST" id="form-editar">
{% csrf_token %}

<label>Título</label>
<input type="text" name="titulo" id="edit-titulo">

<label>Descrição</label>
<textarea name="descricao" id="edit-descricao"></textarea>

<label>Status</label>
<select name="status" id="edit-status">
{% for v, l in status_choices %}
<option value="{{ v }}">{{ l }}</option>
{% endfor %}
</select>

<label>Responsável</label>
<select name="responsavel" id="edit-responsavel">
{% for u in usuarios %}
<option value="{{ u.id }}">{{ u.username }}</option>
{% endfor %}
</select>

<label>Departamento</label>
<select name="departamento" id="edit-departamento">
{% for d in departamentos %}
<option value="{{ d.id }}">{{ d.nome }}</option>
{% endfor %}
</select>

<button type="submit">Salvar Alterações</button>
</form>
</div>
</div>

<!-- ================= JS ================= -->
<script>
let dragged = null;
let isDragging = false;

/* DRAG & DROP */
document.addEventListener('dragstart', e => {
    if (e.target.classList.contains('demanda')) {
        dragged = e.target;
        isDragging = true;
    }
});

document.addEventListener('dragend', () => {
    setTimeout(() => isDragging = false, 50);
});

document.addEventListener('dragover', e => {
    if (e.target.classList.contains('dia')) e.preventDefault();
});

document.addEventListener('drop', e => {
    if (e.target.classList.contains('dia')) {
        e.preventDefault();

        const novaData = e.target.dataset.data;
        const demandaId = dragged.dataset.id;

        fetch("{% url 'mover_demanda' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `demanda_id=${demandaId}&nova_data=${novaData}`
        });

        e.target.appendChild(dragged);
    }
});

/* MODAIS */
function abrirCriar(data) {
    if (isDragging) return;
    document.getElementById('data-demanda').value = data;
    document.getElementById('modal-criar').style.display = 'block';
}

function abrirEditar(id, titulo, descricao, status, resp, depto) {
    if (isDragging) return;

    document.getElementById('edit-titulo').value = titulo;
    document.getElementById('edit-descricao').value = descricao;
    document.getElementById('edit-status').value = status;
    document.getElementById('edit-responsavel').value = resp;
    document.getElementById('edit-departamento').value = depto;

    document.getElementById('form-editar').action = `/editar-demanda/${id}/`;
    document.getElementById('modal-editar').style.display = 'block';
}

function fecharModal(id) {
    document.getElementById(id).style.display = 'none';
}
</script>

</body>
</html>
